name: 🚀 SSH Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: 🚀 Deploy to Production Server

    steps:
    - name: 📦 Checkout Repository
      uses: actions/checkout@v4

    - name: 🔑 Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 🔐 Add Server to Known Hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: 🚀 Deploy to Production
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "🚀 Starting deployment..."

        # Navigate to project directory
        cd /var/www/bvote-2025 || { echo "❌ Project directory not found"; exit 1; }

        # Pull latest changes
        echo "📦 Pulling latest changes..."
        git pull origin main

        # Install backend dependencies
        echo "📦 Installing backend dependencies..."
        cd backend
        npm install --production

        # Install admin dependencies and build
        echo "🏗️ Building admin panel..."
        cd ../admin
        npm install
        npm run build

        # Restart services
        echo "🔄 Restarting services..."
        cd ..
        pm2 restart all || pm2 start ecosystem.config.js

        echo "✅ Deployment completed successfully!"
        EOF

    - name: 🔔 Notify Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment completed successfully!"
        else
          echo "❌ Deployment failed!"
        fi
