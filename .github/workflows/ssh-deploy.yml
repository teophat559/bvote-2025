name: ðŸš€ SSH Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy to Production Server

    steps:
    - name: ðŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ”‘ Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ðŸ” Add Server to Known Hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: ðŸš€ Deploy to Production
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "ðŸš€ Starting deployment..."

        # Navigate to project directory
        cd /var/www/bvote-2025 || { echo "âŒ Project directory not found"; exit 1; }

        # Pull latest changes
        echo "ðŸ“¦ Pulling latest changes..."
        git pull origin main

        # Install backend dependencies
        echo "ðŸ“¦ Installing backend dependencies..."
        cd backend
        npm install --production

        # Install admin dependencies and build
        echo "ðŸ—ï¸ Building admin panel..."
        cd ../admin
        npm install
        npm run build

        # Restart services
        echo "ðŸ”„ Restarting services..."
        cd ..
        pm2 restart all || pm2 start ecosystem.config.js

        echo "âœ… Deployment completed successfully!"
        EOF

    - name: ðŸ”” Notify Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
        else
          echo "âŒ Deployment failed!"
        fi
